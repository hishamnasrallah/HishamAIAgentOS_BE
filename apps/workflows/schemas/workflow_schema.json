{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "HishamOS Workflow Definition Schema",
    "description": "JSON Schema for defining multi-step AI-driven workflows in HishamOS",
    "type": "object",
    "required": [
        "name",
        "version",
        "steps"
    ],
    "properties": {
        "name": {
            "type": "string",
            "description": "Human-readable workflow name",
            "minLength": 1,
            "maxLength": 200,
            "examples": [
                "Bug Lifecycle",
                "Feature Development",
                "Code Review"
            ]
        },
        "version": {
            "type": "string",
            "pattern": "^\\d+\\.\\d+(\\.\\d+)?$",
            "description": "Semantic version (e.g., 1.0, 2.1.3)",
            "examples": [
                "1.0",
                "2.0.1"
            ]
        },
        "description": {
            "type": "string",
            "description": "Detailed workflow description",
            "maxLength": 1000
        },
        "metadata": {
            "type": "object",
            "description": "Additional workflow metadata",
            "properties": {
                "author": {
                    "type": "string"
                },
                "created_date": {
                    "type": "string",
                    "format": "date"
                },
                "tags": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    }
                }
            }
        },
        "steps": {
            "type": "array",
            "description": "Array of workflow steps",
            "minItems": 1,
            "items": {
                "$ref": "#/definitions/step"
            }
        }
    },
    "definitions": {
        "step": {
            "type": "object",
            "required": [
                "id",
                "agent"
            ],
            "properties": {
                "id": {
                    "type": "string",
                    "pattern": "^[a-z][a-z0-9_]*$",
                    "description": "Unique step identifier (lowercase, underscores)",
                    "examples": [
                        "triage",
                        "assign_developer",
                        "code_review"
                    ]
                },
                "name": {
                    "type": "string",
                    "description": "Human-readable step name",
                    "examples": [
                        "Bug Triage",
                        "Assign to Developer"
                    ]
                },
                "agent": {
                    "type": "string",
                    "description": "Agent name or ID to execute this step",
                    "examples": [
                        "bug-triage-agent",
                        "coding-agent",
                        "qa-agent"
                    ]
                },
                "inputs": {
                    "type": "object",
                    "description": "Input parameters for the step (supports {{variable}} syntax)",
                    "additionalProperties": true,
                    "examples": [
                        {
                            "bug_description": "{{input.bug_description}}",
                            "project_context": "{{input.project}}"
                        }
                    ]
                },
                "condition": {
                    "type": "string",
                    "description": "Optional condition to execute this step (supports {{variable}} and boolean operators)",
                    "examples": [
                        "{{steps.triage.output.severity}} > 3",
                        "{{input.requires_review}} == true"
                    ]
                },
                "on_success": {
                    "type": "string",
                    "description": "Next step ID on successful execution",
                    "examples": [
                        "assign",
                        "code_review"
                    ]
                },
                "on_failure": {
                    "type": "string",
                    "description": "Next step ID on failure (optional, defaults to workflow failure)",
                    "examples": [
                        "notify_team",
                        "escalate"
                    ]
                },
                "max_retries": {
                    "type": "integer",
                    "minimum": 0,
                    "maximum": 10,
                    "default": 3,
                    "description": "Maximum retry attempts on failure"
                },
                "timeout_seconds": {
                    "type": "integer",
                    "minimum": 1,
                    "maximum": 3600,
                    "default": 300,
                    "description": "Step execution timeout in seconds"
                },
                "skip_if": {
                    "type": "string",
                    "description": "Condition to skip this step",
                    "examples": [
                        "{{steps.triage.output.severity}} == 1"
                    ]
                },
                "parallel": {
                    "type": "boolean",
                    "default": false,
                    "description": "Whether this step can execute in parallel with other steps in the same parallel_group"
                },
                "parallel_group": {
                    "type": "string",
                    "description": "Group identifier for steps that should execute in parallel. Steps with the same parallel_group and parallel=true will execute simultaneously",
                    "examples": [
                        "processing",
                        "validation",
                        "data_processing"
                    ]
                },
                "depends_on": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    },
                    "description": "List of step IDs that must complete before this step can execute. Used for parallel execution dependency management",
                    "examples": [
                        ["step1", "step2"],
                        ["init"]
                    ]
                },
                "branch_group": {
                    "type": "string",
                    "description": "Identifier for a conditional branch group. Steps with the same branch_group are mutually exclusive - only one branch matching its condition will execute",
                    "examples": [
                        "priority_branch",
                        "severity_branch"
                    ]
                },
                "merge_after": {
                    "type": "string",
                    "description": "Branch group ID to merge after. This step will wait for all branches in the specified group to complete (or be skipped) before executing",
                    "examples": [
                        "priority_branch",
                        "severity_branch"
                    ]
                },
                "step_type": {
                    "type": "string",
                    "enum": ["agent", "merge", "loop", "sub_workflow"],
                    "default": "agent",
                    "description": "Type of step. 'agent' executes an agent, 'merge' merges branch groups, 'loop' executes a loop, 'sub_workflow' executes a nested workflow"
                },
                "loop": {
                    "type": "object",
                    "description": "Loop configuration (required if step_type is 'loop')",
                    "properties": {
                        "type": {
                            "type": "string",
                            "enum": ["for", "while"],
                            "description": "Loop type: 'for' iterates over an array, 'while' loops while condition is true"
                        },
                        "over": {
                            "type": "string",
                            "description": "For 'for' loops: path to array to iterate over (e.g., '{{steps.get_items.output.items}}')"
                        },
                        "variable": {
                            "type": "string",
                            "description": "Variable name for loop item (e.g., 'item', 'task')"
                        },
                        "condition": {
                            "type": "string",
                            "description": "For 'while' loops: condition to check before each iteration"
                        },
                        "max_iterations": {
                            "type": "integer",
                            "minimum": 1,
                            "maximum": 1000,
                            "default": 100,
                            "description": "Maximum number of loop iterations to prevent infinite loops"
                        },
                        "steps": {
                            "type": "array",
                            "description": "Steps to execute in each loop iteration",
                            "items": {
                                "$ref": "#/definitions/step"
                            }
                        }
                    },
                    "required": ["type"]
                },
                "sub_workflow": {
                    "type": "object",
                    "description": "Sub-workflow configuration (required if step_type is 'sub_workflow')",
                    "properties": {
                        "workflow_id": {
                            "type": "string",
                            "description": "ID or slug of the workflow to execute"
                        },
                        "input_mapping": {
                            "type": "object",
                            "description": "Map parent workflow context to sub-workflow inputs",
                            "additionalProperties": true
                        },
                        "output_mapping": {
                            "type": "object",
                            "description": "Map sub-workflow outputs back to parent workflow context",
                            "additionalProperties": {
                                "type": "string"
                            }
                        }
                    },
                    "required": ["workflow_id"]
                }
            }
        }
    },
    "additionalProperties": false
}